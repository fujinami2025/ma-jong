<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>2äººå¯¾æˆ¦éº»é›€ï¼ˆä»®ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 30px;
    }

    #status {
      font-size: 1.5em;
      margin-bottom: 20px;
    }

    #discards-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    .discards {
      display: flex;
      justify-content: center;
      margin: 6px 0;
    }

    #hand-display {
      margin-top: 12px;
      flex-direction: row;
    }
  </style>
</head>

<body>
  <div id="status">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...</div>

  <div id="game" style="display: none;">
    <h2>å¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</h2>
    <p>ã‚ãªãŸã¯ <span id="player"></span> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚</p>
    <p>ãƒ«ãƒ¼ãƒ ID: <span id="room"></span></p>

    <div id="discards-container">
      <div id="opponent-discards" style="margin-bottom: 10px;"></div>
      <div id="my-discards" style="margin-bottom: 10px;"></div>
      <div id="hand-display"></div>
    </div>
      <button id="ron-button" style="display:none; margin-top:10px;">ãƒ­ãƒ³ã™ã‚‹</button>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const gameDiv = document.getElementById('game');
    const playerSpan = document.getElementById('player');
    const roomSpan = document.getElementById('room');
    const handDiv = document.getElementById('hand-display');
    const opponentDiscards = document.getElementById('opponent-discards');
    const myDiscards = document.getElementById('my-discards');
    const ronButton = document.getElementById('ron-button');

    let myPlayerIndex = null;
    let myRoomId = null;
    let canDiscard = false;
    let ronPendingPai = null;

    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${location.host}/ws`);

    ws.onopen = () => {
      statusDiv.textContent = 'å¾…æ©Ÿä¸­â€¦ ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚';
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'start') {
        statusDiv.style.display = 'none';
        gameDiv.style.display = 'block';
        playerSpan.textContent = data.playerIndex === 0 ? 'å…ˆæ‰‹' : 'å¾Œæ‰‹';
        roomSpan.textContent = data.roomId;
        myPlayerIndex = data.playerIndex;
        myRoomId = data.roomId;

        if (data.playerIndex === 0) canDiscard = true;
        if (data.handString) showHandFromShoupaiString(data.handString); // âœ… å¤‰æ›´
      }

      if (data.type === 'tsumo') {
        if (data.playerIndex === myPlayerIndex) {
          if (data.handString) showHandFromShoupaiString(data.handString); // âœ… å¤‰æ›´
          canDiscard = true;
        }
      }

      if (data.type === 'ronCheck') {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ³ã™ã‚‹ã‹ã©ã†ã‹é¸ã°ã›ã‚‹
        ronPendingPai = data.pai;
        showRonButton();
      }

      if (data.type === 'ron') {
        if (data.winner === myPlayerIndex) {
          alert('ğŸ‰ ã‚ãªãŸãŒãƒ­ãƒ³ã—ã¾ã—ãŸï¼ç²å¾—ç‰Œ: ' + convertMPSZToPaiIndex(data.pai));
        } else {
          alert('ç›¸æ‰‹ãŒãƒ­ãƒ³ã—ã¾ã—ãŸã€‚');
        }
      }
      if (data.type === 'dahai') {
        if (data.playerIndex !== myPlayerIndex) {
          showOpponentDiscardedTile(data.pai);
        }
      }

      if (data.type === 'waiting') {
        statusDiv.textContent = `å¾…æ©Ÿä¸­â€¦ ç¾åœ¨ ${data.count} äººãŒå¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚`;
      }
    };

    function showRonButton() {
      ronButton.style.display = 'inline-block';
    }

    ronButton.onclick = () => {
      ronButton.style.display = 'none';
      if (ronPendingPai !== null) {
        ws.send(JSON.stringify({
          type: 'ron',
          roomId: myRoomId,
          playerIndex: myPlayerIndex,
          pai: ronPendingPai
        }));
        ronPendingPai = null;
      }
    };
    /*function showHand(hand) {
      handDiv.innerHTML = 'ã‚ãªãŸã®æ‰‹ç‰Œ: ';
      const sorted = [...hand].sort((a, b) => a - b);
      sorted.forEach(pai => {
        const img = document.createElement('img');
        img.src = `/dist/image/${getTileImage(pai)}`;
        img.alt = pai;
        img.style.width = '40px';
        img.style.margin = '2px';
        img.style.cursor = 'pointer';

        img.onclick = () => {
          if (!canDiscard) return;
          canDiscard = false;
          img.style.opacity = 0.5;
          img.style.pointerEvents = 'none';
          showMyDiscardedTile(pai);
          ws.send(JSON.stringify({
            type: 'dahai',
            roomId: myRoomId,
            playerIndex: myPlayerIndex,
            pai
          }));
        };
        handDiv.appendChild(img);
      });
    }*/
    function showHandFromShoupaiString(handStr) {
      handDiv.innerHTML = 'ã‚ãªãŸã®æ‰‹ç‰Œ: ';
      let suit = '';
      for (let i = 0; i < handStr.length; i++) { //m123p456s789z1233
        const ch = handStr[i]; //m p s z
        if ('mpsz'.includes(ch)) {
          suit = ch;
        } else if (/\d/.test(ch)) {
          const tileStr = `${suit}${ch}`;
          const img = document.createElement('img');
          img.src = `/dist/image/${suit}${ch}.gif`;  // â† m1.gif ãªã©
          img.alt = `${suit}${ch}`;
          img.style.width = '40px';
          img.style.margin = '2px';
          img.style.cursor = 'pointer';

          img.onclick = () => {
            console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");ã€€//ãªãœã‹å‡ºã¦ã“ãªã„logã€€è¬ã€€ã‚µãƒ¼ãƒãƒ¼å´ã«æŒ‡ç¤ºé£›ã°ã—ã¦ãªã„ã®ã§ã¯ï¼Ÿã€type:ã‹ãªã‚“ã‹ã§ã‚µãƒ¼ãƒãƒ¼å´ã«è¡¨ç¤ºé ¼ã‚ã°ï¼Ÿ
            if (!canDiscard) return;
            canDiscard = false;
            img.style.opacity = 0.5;
            img.style.pointerEvents = 'none';

            const paiIndex = convertMPSZToPaiIndex(tileStr);
            showMyDiscardedTile(paiIndex);

            ws.send(JSON.stringify({
              type: 'dahai',
              roomId: myRoomId,
              playerIndex: myPlayerIndex,
              pai: paiIndex
            }));
          };


          handDiv.appendChild(img);
        }
      }
    }
    function getTileImage(paiNumber) {
      const typeIndex = Math.floor(paiNumber / 4);
      if (typeIndex < 9) return `m${typeIndex + 1}.gif`;
      if (typeIndex < 18) return `p${typeIndex - 9 + 1}.gif`;
      if (typeIndex < 27) return `s${typeIndex - 18 + 1}.gif`;
      return `z${typeIndex - 27 + 1}.gif`;
    }
    //10 m3 floor10/4 = 2

    function showOpponentDiscardedTile(pai) {
      if (opponentDiscards.children.length === 0) {
        opponentDiscards.innerHTML = '<p>ç›¸æ‰‹ã®æ¨ã¦ç‰Œ:</p>';
      }
      const img = document.createElement('img');
      img.src = `/dist/image/${getTileImage(pai)}`;
      img.alt = pai;
      img.style.width = '40px';
      img.style.margin = '2px';
      opponentDiscards.appendChild(img);
    }

    function showMyDiscardedTile(pai) {
      if (myDiscards.children.length === 0) {
        myDiscards.innerHTML = '<p>ã‚ãªãŸã®æ¨ã¦ç‰Œ:</p>';
      }
      const img = document.createElement('img');
      img.src = `/dist/image/${getTileImage(pai)}`;
      img.alt = pai;
      img.style.width = '40px';
      img.style.margin = '2px';
      myDiscards.appendChild(img);
    }

    ws.onclose = () => {
      statusDiv.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚';
    };

    function convertMPSZToPaiIndex(paiStr) {
      const num = parseInt(paiStr[1]);
      const suit = paiStr[0];
      let base = 0;
      if (suit === 'p') base = 9;
      else if (suit === 's') base = 18;
      else if (suit === 'z') base = 27;
      const tileIndex = base + num - 1;
      return tileIndex * 4; // å¸¸ã«0ç•ªç›®ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    }

    /*function convertHandStringToIndexes(handString) {
      const result = [];
      const suits = ['m', 'p', 's', 'z'];

      for (const suit of suits) {
        const regex = new RegExp(`([1-9]+)${suit}`, 'g');
        let match;
        while ((match = regex.exec(handString)) !== null) {
          const numbers = match[1];
          for (const ch of numbers) {
            const num = parseInt(ch);
            let base = 0;
            if (suit === 'p') base = 9;
            else if (suit === 's') base = 18;
            else if (suit === 'z') base = 27;
            const tileIndex = base + num - 1;
            result.push(tileIndex * 4); // åŒã˜ç‰Œã®0ç•ªç›®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
          }
        }
      }

      return result.sort((a, b) => a - b);
    }*/

  </script>
</body>

</html>